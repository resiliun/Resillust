---
import "../styles/global.css";
import Inter from "../layouts/inter.astro";
import { Image as AstroImage } from "astro:assets";

const allAssets = import.meta.glob<{ default: ImageMetadata | string }>('/src/assets/artwork/2d/*.{jpeg,jpg,png,gif,webp,avif,mp4,webm,mov}');

const isVideo = (path: string) => /\.(mp4|webm|mov)$/i.test(path);

const groupedFiles: Record<string, any> = {};

await Promise.all(
  Object.keys(allAssets).map(async (path) => {
    const assetModule = await allAssets[path]();
    const src = (assetModule as any).default.src || (assetModule as any).default;
    
    const fileName = path.split('/').pop()?.split('.')[0] || '';

    // 1. CEK APAKAH INI COVER
    const isSpecialCover = fileName.toUpperCase().startsWith('COVER_');

    // 2. BERSIHKAN NAMA (Buang 'COVER_' kalau ada)
    const cleanFileName = fileName.replace(/^COVER_/i, '');

    // 3. PROSES METADATA (Pake nama yang sudah bersih)
    const parts = cleanFileName.split('_');
    const rawTitle = parts[0]; 
    const rawDesc = parts[1] || "No description";
    const rawYear = parts[2] || "2024";

    const titleClean = rawTitle ? rawTitle.split('-').join(' ') : "Untitled";

    if (!groupedFiles[titleClean]) {
      groupedFiles[titleClean] = {
        title: titleClean,
        desc: rawDesc ? rawDesc.split('-').join(' ') : "No description provided.",
        year: rawYear,
        thumbnail: null, 
        slides: [] 
      };
    }

    // 4. MASUKIN KE SLIDE
    const newSlide = {
      src: src, 
      type: isVideo(path) ? 'video' : 'image',
      isCover: isSpecialCover, // Tandai kalau ini file cover
      originalObj: !isVideo(path) ? (assetModule as any).default : null 
    };

    // Kalau ini cover, taruh di paling depan array slides
    if (isSpecialCover) {
      groupedFiles[titleClean].slides.unshift(newSlide);
    } else {
      groupedFiles[titleClean].slides.push(newSlide);
    }
  })
);

const artworks = Object.values(groupedFiles).map((item: any) => {
  // Cari slide yang ditandai 'isCover', kalau gak ada baru ambil image pertama
  const thumbSlide = item.slides.find((s: any) => s.isCover && s.type === 'image') 
                  || item.slides.find((s: any) => s.type === 'image');

  return {
    ...item,
    thumbnail: thumbSlide ? thumbSlide.originalObj : null, 
    fullSrc: thumbSlide ? thumbSlide.src : '', 
  };
}).sort((a: any, b: any) => parseInt(b.year) - parseInt(a.year));
---

<Inter>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <main x-data="{ 
      open: false, 
      currTitle: '', 
      currDesc: '', 
      currYear: '',
      slides: [],       
      activeSlideIndex: 0,
      // Helper function untuk stop video saat slide berubah atau popup close
      stopAllVideos() {
        document.querySelectorAll('video').forEach(vid => vid.pause());
      }
    }" 
    @keydown.escape="open = false; stopAllVideos()"
    class="min-h-screen bg-white pt-[12vw] pb-20 px-4 md:px-8">
    
    <div class="columns-1 sm:columns-2 lg:columns-3 xl:columns-4 gap-4 space-y-4">
      {artworks.map((item, index) => (
        item.thumbnail && (
          <div 
            class="break-inside-avoid group cursor-pointer relative overflow-hidden bg-gray-100" 
            @click={`
              open = true; 
              currTitle = '${item.title.replace(/'/g, "\\'")}'; 
              currDesc = '${item.desc.replace(/'/g, "\\'")}'; 
              currYear = '${item.year}';
              // Kita clone array supaya Alpine mendeteksi perubahan total
              slides = JSON.parse(JSON.stringify(${JSON.stringify(item.slides)}));
              activeSlideIndex = 0;
            `}
          >
            {item.slides.length > 1 && (
              <div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded z-10 backdrop-blur-sm">
                +{item.slides.length - 1}
              </div>
            )}

            <AstroImage 
              src={item.thumbnail} 
              alt={item.title}
              width={1200}
              loading={index < 7 ? "eager" : "lazy"} 
              class="w-full h-auto transition-all duration-500 group-hover:scale-105 group-hover:brightness-75"
            />
          </div>
        )
      ))}
    </div>

    <div x-show="open" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm" 
         x-cloak>
      
      <button @click="open = false; stopAllVideos()" class="absolute top-8 right-8 text-white/50 hover:text-white text-3xl z-[220] transition-colors">&times;</button>

      <div @click.outside="open = false; stopAllVideos()" 
           class="bg-[#1A1B19] flex flex-col md:flex-row max-w-6xl w-full max-h-[90vh] overflow-hidden shadow-2xl border border-white/5 rounded-lg">
        
        <div class="md:w-[65%] bg-[#121212] flex items-center justify-center relative group p-2 select-none">
          
          <button 
            x-show="slides.length > 1"
            @click.stop="activeSlideIndex = (activeSlideIndex === 0) ? slides.length - 1 : activeSlideIndex - 1"
            class="absolute left-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 text-white rounded-full transition-colors backdrop-blur-md">
            &#10094;
          </button>

          <div class="relative w-full h-full flex items-center justify-center">
             <template x-for="(slide, index) in slides" :key="slide.src">
                <div x-show="activeSlideIndex === index" 
                     x-transition:enter="transition ease-out duration-300"
                     x-transition:enter-start="opacity-0 scale-95"
                     x-transition:enter-end="opacity-100 scale-100"
                     class="w-full h-full flex items-center justify-center">
                  
                  <template x-if="slide.type === 'video'">
                    <video 
                        x-effect="activeSlideIndex === index ? $el.play() : $el.pause()"
                        :src="slide.src" 
                        controls 
                        loop 
                        muted 
                        playsinline
                        class="max-w-full max-h-[75vh] object-contain shadow-lg bg-black">
                    </video>
                  </template>

                  <template x-if="slide.type === 'image'">
                    <img :src="slide.src" class="max-w-full max-h-[75vh] object-contain shadow-lg" />
                  </template>
                </div>
             </template>
          </div>

          <button 
            x-show="slides.length > 1"
            @click.stop="activeSlideIndex = (activeSlideIndex === slides.length - 1) ? 0 : activeSlideIndex + 1"
            class="absolute right-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 text-white rounded-full transition-colors backdrop-blur-md">
            &#10095;
          </button>

          <div x-show="slides.length > 1" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 z-20">
            <template x-for="(slide, index) in slides" :key="index">
              <button @click="activeSlideIndex = index" 
                      class="w-2 h-2 rounded-full transition-all"
                      :class="activeSlideIndex === index ? 'bg-white w-4' : 'bg-white/30 hover:bg-white/50'">
              </button>
            </template>
          </div>

        </div>

        <div class="md:w-[35%] flex flex-col p-6 md:p-10 text-white relative bg-[#1A1B19]">
          <h2 class="text-3xl font-serif italic mb-2 tracking-tight" x-text="currTitle"></h2>
          <div class="w-full h-[1px] bg-white/20 mb-6"></div>

          <div class="flex-1 overflow-y-auto pr-2 custom-scrollbar">
            <p class="text-xs uppercase tracking-[0.2em] mb-4 text-white/60 font-bold">Desc:</p>
            <p class="text-sm font-light leading-relaxed text-white/80 whitespace-pre-line" x-text="currDesc"></p>
          </div>

          <div class="mt-8 flex flex-col items-end">
             <div class="w-24 h-[1px] bg-white/20 mb-2"></div>
             <p class="text-[11px] italic font-serif text-white/40">
               tahun terbit: <span x-text="currYear"></span>
             </p>
             <p x-show="slides.length > 1" class="text-[10px] text-white/30 mt-1">
               Slide <span x-text="activeSlideIndex + 1"></span> / <span x-text="slides.length"></span>
             </p>
          </div>
        </div>

      </div>
    </div>
  </main>
</Inter>

<style>
  [x-cloak] { display: none !important; }
  
  .custom-scrollbar::-webkit-scrollbar { width: 3px; }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }

  .break-inside-avoid {
    break-inside: avoid;
    display: block;
    width: 100%;
  }
</style>