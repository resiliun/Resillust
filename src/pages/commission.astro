---
import Nav from '../layouts/nav.astro';
import { Image as AstroImage } from "astro:assets";

const commissions = [
  {
    id: '2d',
    title: '2D ASSETS',
    subtitle: 'Vtuber & Game Assets',
    status: 'Open',
    type: 'active',
    img: '/img/2d-sample.jpg', 
    iconPath: '/icons/a.svg', 
    prices: [
      { item: 'Icon/Prop', price: '80-100 K' },
      { item: 'Half Body Parts', price: '250-300 K' },
      { item: 'Full Set', price: '500 K' }
    ]
  },
  {
    id: 'illus',
    title: 'ILLUSTRATION',
    subtitle: 'Narrative & Character',
    status: 'Open',
    type: 'active',
    img: '/img/illus-sample.jpg', 
    iconPath: '/icons/b.svg', 
    prices: [
      { item: 'Portrait', price: '300 K' },
      { item: 'Half Body', price: '600 K' },
      { item: 'Full Body', price: '1.000 K' },
      { item: 'Narrative Scene', price: '1.500 K' }
    ]
  },
  {
    id: '3d',
    title: '3D ASSETS',
    subtitle: 'Modeling & Texture',
    status: 'Closed',
    type: 'disabled', 
    img: '', 
    iconPath: '/icons/c.svg', 
    prices: []
  }
];
---

<Nav>
  <main class="w-full h-screen bg-[#F5F5F0] overflow-hidden flex flex-col font-piazzolla selection:bg-black selection:text-white">
    
    <header class="h-[12vh] flex items-center justify-between px-6 md:px-12 border-b border-black/5 animate-fade-down">
      <h1 class="font-italiana text-2xl md:text-3xl tracking-tighter uppercase overflow-hidden whitespace-nowrap border-r-2 border-black/50 animate-typewriter-title">
        Commission <span class="italic font-light opacity-30">Manifesto</span>
      </h1>
      <div class="flex items-center gap-4 md:gap-6 opacity-0 animate-fade-in [animation-delay:1s] [animation-fill-mode:forwards]">
        <span class="text-[9px] tracking-[0.4em] uppercase opacity-40 hidden md:block">Resillust Studio / 2026</span>
        <div class="w-8 md:w-12 h-[1px] bg-black/20"></div>
        <button onclick="openCommissionForm()" class="text-[10px] font-bold tracking-[0.3em] uppercase hover:line-through transition-all">Open Forum</button>
      </div>
    </header>

    <section class="flex-1 flex flex-col md:flex-row items-stretch overflow-hidden relative">
      {commissions.map((item, index) => (
        <div 
          id={`card-${item.id}`}
          class:list={[
            "relative flex-1 transition-all duration-[800ms] cubic-bezier(0.23, 1, 0.32, 1) overflow-hidden border-b md:border-b-0 md:border-r border-black/5 last:border-0 group/card card-main opacity-0 animate-fade-up",
            item.type === 'disabled' ? 'grayscale cursor-not-allowed opacity-60 bg-zinc-200' : 'cursor-pointer card-interactive'
          ]}
          style={`animation-delay: ${0.2 * (index + 1)}s; animation-fill-mode: forwards;`}
          data-id={item.id}
        >
          <div class="collapsed-view absolute inset-0 flex flex-col items-center justify-center p-8 transition-all duration-700 group-hover/card:bg-white/40">
             <span class="text-[15vw] md:text-[10vw] font-italiana opacity-[0.03] absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 select-none group-hover/card:opacity-[0.07] transition-opacity uppercase">{item.id}</span>
             <div class="w-12 h-12 md:w-16 md:h-16 border border-black/10 flex items-center justify-center rotate-45 group-hover/card:rotate-0 transition-all duration-700 mb-6 p-3 md:p-4">
                <img src={item.iconPath} class="w-full h-full object-contain pointer-events-none" alt="icon" />
             </div>
             <h2 class="font-italiana text-xl md:text-2xl tracking-[0.3em] uppercase text-center group-hover/card:tracking-[0.5em] transition-all duration-700">{item.title}</h2>
          </div>

          <div class="expanded-view opacity-0 pointer-events-none absolute inset-0 flex flex-col md:flex-row h-full w-full bg-[#F5F5F0] z-50">
            <div class="w-full md:w-[55%] h-[40%] md:h-full relative overflow-hidden bg-zinc-300">
                <img src={item.img} alt={item.title} class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-[1.5s]" />
                <div class="absolute bottom-8 left-8 md:bottom-12 md:left-12 z-20 text-white mix-blend-difference font-italiana">
                   <h2 class="text-4xl md:text-6xl uppercase leading-none animate-fade-right">{item.title}</h2>
                </div>
            </div>

            <div class="w-full md:w-[45%] h-[60%] md:h-full p-8 md:p-20 flex flex-col justify-center relative overflow-y-auto custom-scrollbar-thin">
                <button class="btn-close-card absolute top-6 right-6 md:top-10 md:right-10 group/close p-2 md:p-4 transition-transform hover:scale-110 z-[60]">
                  <span class="hidden md:block text-[10px] tracking-widest uppercase opacity-40 group-hover/close:opacity-100">X (Esc)</span>
                  <span class="md:hidden bg-black text-white w-10 h-10 rounded-full flex items-center justify-center text-lg">✕</span>
                </button>

                <div class="space-y-8 md:space-y-12 max-w-md animate-fade-in [animation-delay:0.4s]">
                    <header class="space-y-2 md:space-y-4">
                        <div class="flex items-center gap-4">
                            <span class:list={["w-2 h-2 rounded-full animate-pulse", item.status === 'Open' ? 'bg-green-500' : 'bg-red-500']}></span>
                            <span class="text-[10px] tracking-[0.3em] uppercase font-bold">{item.status}</span>
                        </div>
                        <h3 class="text-3xl md:text-4xl font-italiana italic">{item.subtitle}</h3>
                    </header>

                    <ul class="space-y-4 md:space-y-6">
                        {item.prices.map((p) => (
                          <li class="flex justify-between items-baseline border-b border-black/5 pb-2 group/price hover:border-black transition-colors duration-500">
                            <span class="text-base md:text-lg font-light group-hover/price:translate-x-2 transition-transform duration-500">{p.item}</span>
                            <span class="font-mono text-[10px] md:text-[11px] opacity-40 italic group-hover/price:opacity-100 transition-opacity">{p.price}</span>
                          </li>
                        ))}
                    </ul>

                    <button onclick="openCommissionForm()" class="w-full py-4 md:py-5 bg-black text-white text-[10px] font-bold tracking-[0.5em] uppercase hover:bg-zinc-800 hover:tracking-[0.7em] transition-all duration-500">
                      Initialize Project
                    </button>
                </div>
            </div>
          </div>
        </div>
      ))}
    </section>

    <div id="form-modal-overlay" class="fixed inset-0 bg-[#F5F5F0] z-[200] hidden opacity-0 transition-opacity duration-500">
      
      <button id="global-form-close" onclick="closeCommissionForm()" class="md:hidden fixed top-6 right-6 z-[300] bg-black text-white w-12 h-12 rounded-full flex items-center justify-center shadow-xl active:scale-90 transition-all">
        <span class="text-lg">✕</span>
      </button>

      <button id="mobile-info-btn" class="md:hidden fixed bottom-8 right-6 z-[250] bg-zinc-800 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl animate-bounce">
        <span class="font-serif italic text-2xl">i</span>
      </button>

      <div class="w-full h-full flex flex-col md:flex-row overflow-hidden">
        
        <div id="guidelines-sidebar" class="w-full md:w-[40%] h-full bg-[#1A1B19] text-[#F5F5F0] p-10 md:p-20 flex flex-col fixed md:relative z-[350] md:z-auto transition-transform duration-500 translate-y-full md:translate-y-0 overflow-y-auto">
            <header class="mb-12 flex justify-between items-start">
                <div>
                   <button onclick="closeCommissionForm()" class="hidden md:flex text-[10px] tracking-[0.4em] uppercase opacity-40 hover:opacity-100 mb-8 items-center gap-2 transition-all hover:-translate-x-2">
                       <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                       Back
                   </button>
                   <h4 class="font-italiana text-4xl md:text-5xl italic">Rules & <br/>Guidelines</h4>
                </div>
                <button id="close-mobile-info" class="md:hidden bg-white/10 p-4 rounded-full text-xs tracking-widest uppercase">✕ Close</button>
            </header>

            <div class="flex-1 space-y-12">
                <div class="grid grid-cols-2 gap-8 border-t border-white/10 pt-8">
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold tracking-widest uppercase text-red-400">I Don't Draw</p>
                        <ul class="text-sm font-light opacity-60 leading-relaxed"><li>• Mecha / Gore</li><li>• Violence</li></ul>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold tracking-widest uppercase text-green-400">I Can</p>
                        <ul class="text-sm font-light opacity-60 leading-relaxed"><li>• Male / Female</li><li>• OC / Fanart</li></ul>
                    </div>
                </div>
                <section class="text-sm font-light opacity-80 space-y-4 border-b border-white/5 pb-12">
                    <p><strong>Payment:</strong> Full payment upfront via PayPal / Local Bank.</p>
                    <p><strong>Copyright:</strong> Personal use only.</p>
                    <p><strong>Revisions:</strong> Free at Sketch & Base stages.</p>
                </section>
            </div>
        </div>

        <div class="w-full md:w-[60%] h-full p-6 md:p-24 overflow-y-auto bg-white flex flex-col">
            <div class="max-w-xl w-full mx-auto my-auto space-y-12 md:space-y-16 py-20 md:py-0">
                <header>
                    <h2 class="font-italiana text-3xl md:text-4xl uppercase italic text-center md:text-left">Form Inquiry</h2>
                    <div class="w-12 h-[1px] bg-black mt-4 mx-auto md:mx-0"></div>
                </header>
                
                <form id="commission-order-form" class="space-y-10 md:space-y-12">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10">
                        <div class="flex flex-col gap-2 border-b border-black/10 pb-2 focus-within:border-black transition-colors">
                            <label class="text-[9px] uppercase tracking-widest opacity-40">Client Name</label>
                            <input type="text" name="name" required class="bg-transparent outline-none text-lg" />
                        </div>
                        <div class="flex flex-col gap-2 border-b border-black/10 pb-2 focus-within:border-black transition-colors">
                            <label class="text-[9px] uppercase tracking-widest opacity-40">Contact (IG/WA)</label>
                            <input type="text" name="contact" required class="bg-transparent outline-none text-lg" />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-10">
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] uppercase tracking-widest opacity-40">Project Type</label>
                            <select id="select-type" name="category" required class="bg-transparent border-b border-black/10 py-2 outline-none focus:border-black text-sm md:text-base">
                                <option value="">Select Service</option>
                                <option value="2d">2D Asset</option>
                                <option value="illustration">Illustration</option>
                                <option value="3d">3D Asset</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-[9px] uppercase tracking-widest opacity-40">Coverage</label>
                            <select id="select-coverage" name="packageName" required disabled class="bg-transparent border-b border-black/10 py-2 outline-none disabled:opacity-20 focus:border-black text-sm md:text-base">
                                <option value="">Select type first</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex flex-col gap-2">
                        <label class="text-[9px] uppercase tracking-widest opacity-40">Description / Brief</label>
                        <textarea name="description" rows="4" class="bg-[#F0F0EB] p-5 md:p-6 outline-none resize-none text-base md:text-lg border border-black/5 focus:border-black/20 transition-all" placeholder="Details (Poses, References, etc)"></textarea>
                    </div>

                    <button type="submit" id="submit-btn" class="w-full py-5 md:py-6 bg-black text-white font-bold tracking-[0.6em] text-[10px] uppercase hover:bg-zinc-800 transition-all active:scale-[0.98]">Submit Order</button>
                </form>
            </div>
        </div>
      </div>
    </div>
  </main>
</Nav>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Italiana&display=swap');
  .font-italiana { font-family: 'Italiana', serif; }
  
  :global(body.modal-open) { overflow: hidden !important; position: fixed; width: 100%; }

  /* Animations */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes typewriter { from { width: 0; } to { width: 100%; } }
  @keyframes blink { 50% { border-color: transparent; } }

  .animate-fade-up { animation: fadeUp 1s ease forwards; }
  .animate-fade-down { animation: fadeDown 1s ease forwards; }
  .animate-fade-in { animation: fadeIn 1s ease forwards; }
  .animate-typewriter-title { animation: typewriter 2s steps(40) forwards, blink 0.8s infinite; }

  /* Card States Desktop */
  @media (min-width: 768px) {
    .card-active { flex: 10 !important; cursor: default !important; }
    .card-active .collapsed-view { opacity: 0; pointer-events: none; }
    .card-active .expanded-view { opacity: 1; pointer-events: auto; }
    .card-inactive { flex: 0.1 !important; opacity: 0.1; filter: grayscale(1); pointer-events: none; }
  }

  /* Card States Mobile - Using Transform instead of Flex to avoid jumping */
  @media (max-width: 767px) {
    .card-active { position: fixed; inset: 0; z-index: 100; flex: none !important; }
    .card-active .expanded-view { opacity: 1; pointer-events: auto; }
  }

  .custom-scrollbar-thin::-webkit-scrollbar { width: 2px; }
  .custom-scrollbar-thin::-webkit-scrollbar-thumb { background: #1A1B19; }
</style>

<script is:inline define:vars={{ commissions }}>
  const lockScroll = () => document.body.classList.add('modal-open');
  const unlockScroll = () => document.body.classList.remove('modal-open');

  const cards = document.querySelectorAll('.card-interactive');
  const closeBtns = document.querySelectorAll('.btn-close-card');
  const sidebar = document.getElementById('guidelines-sidebar');
  const globalClose = document.getElementById('global-form-close');

  // Mobile Info Toggle Logic
  const mobileInfoBtn = document.getElementById('mobile-info-btn');
  const closeMobileInfoBtn = document.getElementById('close-mobile-info');

  mobileInfoBtn?.addEventListener('click', () => {
    sidebar.classList.remove('translate-y-full');
    sidebar.classList.add('translate-y-0');
    // Hide main close button when info is open to avoid mess
    if(globalClose) globalClose.style.display = 'none';
  });

  const closeSidebarMobile = () => {
    if (window.innerWidth < 768) {
        sidebar.classList.add('translate-y-full');
        sidebar.classList.remove('translate-y-0');
        if(globalClose) globalClose.style.display = 'flex';
    }
  };

  closeMobileInfoBtn?.addEventListener('click', closeSidebarMobile);

  // Card Activation
  cards.forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('.btn-close-card')) return;
      if (card.classList.contains('card-active')) return;

      cards.forEach(c => {
        c.classList.remove('card-active');
        c.classList.add('card-inactive');
      });
      card.classList.remove('card-inactive');
      card.classList.add('card-active');
      lockScroll();
    });
  });

  // Card Deactivation
  closeBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      cards.forEach(c => c.classList.remove('card-active', 'card-inactive'));
      unlockScroll();
    });
  });

  // Dropdown Logic
  const coverageData = {
    "2d": ["Icon/Prop", "Half Body Parts", "Full Set"],
    "illustration": ["Portrait", "Half Body", "Full Body", "Narrative Scene"],
    "3d": ["Modeling Object", "Modeling Char"]
  };

  const selectType = document.getElementById('select-type');
  const selectCoverage = document.getElementById('select-coverage');

  selectType?.addEventListener('change', (e) => {
    const val = e.target.value;
    if (val && coverageData[val]) {
      selectCoverage.disabled = false;
      selectCoverage.innerHTML = '<option value="">Select Coverage</option>' + 
        coverageData[val].map(item => `<option value="${item}">${item}</option>`).join('');
    } else {
      selectCoverage.disabled = true;
      selectCoverage.innerHTML = '<option value="">Select type first</option>';
    }
  });

  // Global Forum Modal Logic
  window.openCommissionForm = () => {
    const overlay = document.getElementById('form-modal-overlay');
    overlay.classList.remove('hidden');
    setTimeout(() => { overlay.classList.remove('opacity-0'); lockScroll(); }, 10);
  };

  window.closeCommissionForm = () => {
    const overlay = document.getElementById('form-modal-overlay');
    overlay.classList.add('opacity-0');
    closeSidebarMobile();
    setTimeout(() => { overlay.classList.add('hidden'); unlockScroll(); }, 500);
  };

  // Resend API (Safe)
  const commissionForm = document.getElementById('commission-order-form');
  if (commissionForm) {
    commissionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-btn');
      const originalText = submitBtn.innerText;
      submitBtn.innerText = "SENDING...";
      submitBtn.disabled = true;

      const formData = new FormData(commissionForm);
      const data = {
        name: formData.get('name'),
        contact: formData.get('contact'),
        category: formData.get('category'),
        packageName: formData.get('packageName'),
        description: formData.get('description'),
      };

      try {
        const response = await fetch('/api/commission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
        if (response.ok) {
          alert('Sent successfully!');
          commissionForm.reset();
          window.closeCommissionForm();
        } else {
          const res = await response.json();
          alert('Failed: ' + (res.error || 'Check connection'));
        }
      } catch (error) {
        alert('Network Error.');
      } finally {
        submitBtn.innerText = originalText;
        submitBtn.disabled = false;
      }
    });
  }

  // Keyboard Fix
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        window.closeCommissionForm();
        closeSidebarMobile();
        cards.forEach(c => c.classList.remove('card-active', 'card-inactive'));
        unlockScroll();
    }
  });
</script>